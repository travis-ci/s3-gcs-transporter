language: generic
dist: focal

env:
  global:
    - TARGET=all

addons:
  apt:
    sources:
      - sourceline: "deb https://packages.cloud.google.com/apt cloud-sdk main"
        key_url: "https://packages.cloud.google.com/apt/doc/apt-key.gpg"
    packages:
      - apt-transport-https
      - ca-certificates
      - gnupg
      - google-cloud-sdk

before_script:
  - openssl aes-256-cbc -K $encrypted_709b205d8f9e_key -iv $encrypted_709b205d8f9e_iv -in creds.tar.enc -out creds.tar -d
  - tar xf creds.tar
  - rm -f creds.tar
  # gcloud
  - gcloud auth activate-service-account --key-file=creds.json
  - rm -f creds.json
  - gcloud config set project ${GCS_PROJECT_ID}
  # aws
  - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
  - unzip awscliv2.zip
  - sudo ./aws/install
  - ./import_s3_creds < creds.csv >> ~/.boto

script:
  - make all

after_script:
  - rm -f creds.*
